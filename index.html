<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura Dinámica v2.2 - Con Temas</title> <!-- Versión actualizada -->
    <!-- Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Estilos Base (Por Defecto) --- */

        /* Clase auxiliar para ocultar elementos en pantalla */
        .print-only {
            display: none;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f8f9fa; /* Fondo gris muy claro por defecto */
            transition: background-color 0.3s ease; /* Transición suave */
        }
        .invoice-container {
            max-width: 800px;
            margin: 20px auto;
            border: 1px solid #ddd;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background-color: #fff;
            position: relative; /* Necesario para ::before/::after del tema */
            overflow: hidden; /* Para contener ::before/::after dentro de bordes redondeados si los hay */
            transition: border 0.3s ease, box-shadow 0.3s ease; /* Transición suave */
        }
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
            min-height: 60px;
            position: relative; /* Para que esté por encima de ::before */
            z-index: 1;
        }
        .company-info { /* Usado para "De:" */
            text-align: left;
            flex: 1;
            margin: 0 20px;
            white-space: pre-wrap;
        }
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-basis: 150px;
            flex-shrink: 0;
        }
        .logo img {
            max-width: 100%;
            max-height: 80px;
            object-fit: contain;
        }
        .invoice-details, .sender-receiver-details {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            position: relative; /* Para que esté por encima de ::before */
            z-index: 1;
        }
        .detail-line.hidden, .info-section.hidden {
            display: none;
        }
        .info-section {
            flex: 1;
            min-width: 250px;
        }
        .info-section strong {
            display: block;
            margin-bottom: 5px;
        }
        .info-section span {
             white-space: pre-wrap;
             display: block;
        }
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            position: relative; /* Para que esté por encima de ::before */
            z-index: 1;
        }
        .invoice-table th, .invoice-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
            text-align: right;
            vertical-align: top;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; /* Transición suave */
        }
        .invoice-table th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        .invoice-table th.text-left, .invoice-table td.text-left {
            text-align: left;
        }
        .invoice-summary {
            margin-left: auto;
            width: 300px; /* O usar clases Tailwind w- */
            position: relative; /* Para que esté por encima de ::after */
            z-index: 1;
        }
        .invoice-summary div.summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .invoice-summary div.summary-line.hidden {
             display: none;
        }
        .invoice-summary .total-line {
            font-weight: bold;
            font-size: 1.1em;
            border-top: 2px solid #333;
            padding-top: 8px;
            margin-top: 5px;
             transition: border-color 0.3s ease, color 0.3s ease; /* Transición suave */
        }
        .invoice-note {
            margin-top: 30px;
            font-style: italic;
             white-space: pre-wrap;
             border-top: 1px solid #eee;
             padding-top: 15px;
             position: relative; /* Para que esté por encima de ::after */
             z-index: 1;
        }
        .invoice-note.hidden { display: none; }
         .invoice-note strong {
             display: block;
             margin-bottom: 5px;
             font-style: normal;
         }
        .print-footer {
            display: none; /* Oculto por defecto, visible en impresión */
            padding: 10px 0;
            text-align: center;
            width: 100%;
            position: relative;
            border-top: 1px solid #ddd;
            margin-top: 20px;
            font-size: 0.9em;
            background-color: #fff; /* Fondo blanco por defecto para impresión */
            color: #333; /* Texto oscuro por defecto */
             transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; /* Transición suave */
        }

        /* --- Estilos Tema Púrpura Gradiente (PurpuraGrad) --- */
        body.theme-purpura {
            background-color: #f3e5f5; /* Fondo general lila claro */
        }
        /* === INICIO CAMBIO 1: Aplicar color púrpura SOLO a las etiquetas específicas === */
        .theme-purpura #fecha-line strong,
        .theme-purpura #hora-line strong,
        .theme-purpura #de-section strong,
        .theme-purpura #para-section strong {
            color: #8e24aa; /* Púrpura oscuro (mismo que th) */
        }
        .theme-purpura .invoice-container {
            border: 1px solid #ab47bc; /* Borde púrpura */
            background-color: #fff; /* Fondo blanco */
            box-shadow: 0 0 20px rgba(171, 71, 188, 0.2); /* Sombra púrpura suave */
            border-radius: 8px; /* Bordes redondeados */
        }
        /* Simulación borde superior suave */
        .theme-purpura .invoice-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px; /* Ajusta altura según necesidad */
            background: linear-gradient(to bottom, rgba(206, 147, 216, 0.6), rgba(206, 147, 216, 0)); /* Gradiente púrpura suave */
            border-radius: 8px 8px 0 0;
            z-index: 0; /* Detrás del contenido */
            pointer-events: none; /* Para no interferir con clicks */
        }
        /* Simulación borde inferior suave (efecto brocha) */
        .theme-purpura .invoice-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px; /* Más alto para efecto 'brocha' */
            background: linear-gradient(to top, rgba(206, 147, 216, 0.7), rgba(206, 147, 216, 0)); /* Gradiente púrpura más intenso abajo */
            border-radius: 0 0 8px 8px;
            z-index: 0; /* Detrás del contenido */
            opacity: 0.8; /* Ligeramente más opaco */
            pointer-events: none; /* Para no interferir con clicks */
            /* Nota: Simular una brocha perfectamente irregular es muy complejo solo con CSS/gradientes */
        }
        .theme-purpura .invoice-table th {
            background-color: #e1bee7; /* Lila muy claro */
            color: #8e24aa; /* Púrpura oscuro para texto */
            border-bottom: 1px solid #ce93d8; /* Lila medio */
        }
        .theme-purpura .invoice-table td {
            border-bottom: 1px solid #f3e5f5; /* Lila muy, muy claro */
        }
        .theme-purpura .invoice-summary .total-line {
            border-top: 2px solid #ab47bc; /* Púrpura principal */
            color: #8e24aa; /* Púrpura oscuro */
        }
        /* No necesitamos estilos específicos para print-header ya que se eliminó */
        .theme-purpura .print-footer {
            background-color: #ab47bc; /* Púrpura principal */
            color: #ffffff; /* Texto blanco */
            border-top: none; /* Quitar borde superior por defecto si interfiere */
        }
        .theme-purpura .print-footer p {
             color: #ffffff; /* Asegurar que el texto dentro del footer sea blanco */
        }


        
        /* --- Estilos Tema Azul Abstracto Pro (theme-azul) --- */
        body.theme-azul {
            background-color: #eef5ff; /* Fondo general azul claro */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

         /* Etiquetas (Factura, Fecha, Hora, De, Para) */
        .theme-azul #factura-line strong,
        .theme-azul #fecha-line strong,
        .theme-azul #hora-line strong,
        .theme-azul #de-section strong,
        .theme-azul #para-section strong {
            color: #0d47a1; /* Azul Oscuro */
        }

        .theme-azul .invoice-container {
            border: none; /* Quitar borde default que pueda interferir */
            box-shadow: 0 4px 15px rgba(0, 50, 150, 0.15);
            /* Quitamos los bordes gruesos de aquí, se manejarán en impresión */
            /* border-top: 25px solid #0d47a1; */
            /* border-bottom: 25px solid #0d47a1; */
            padding-top: 20px; /* Padding normal para pantalla */
            padding-bottom: 20px; /* Padding normal para pantalla */
            background-color: #fff; /* Asegurar fondo blanco */
            position: relative; /* Necesario para pseudo-elementos si los usas en pantalla */
            overflow: hidden; /* Contener elementos */
            margin-top: 20px; /* Espacio opcional arriba/abajo en pantalla */
            margin-bottom: 20px;
        }


        /* Estilos de la tabla para el tema azul */
        .theme-azul .invoice-table th {
            background-color: #1e88e5; /* Azul intermedio */
            color: #ffffff; /* Texto blanco */
            border-bottom: 1px solid #1565c0; /* Borde azul más oscuro */
        }
        .theme-azul .invoice-table td {
            border-bottom: 1px solid #bbdefb; /* Borde azul muy claro */
        }

        /* Estilos línea Total para el tema azul */
        .theme-azul .invoice-summary .total-line { /* Asegúrate que el selector sea específico */
            border-top: 2px solid #0d47a1; /* Borde azul oscuro */
            color: #0d47a1; /* Color texto azul oscuro */
        }
        /* (Opcional) Si quieres colorear solo la etiqueta "Total:" como en el tema púrpura */
        /*
        .theme-azul #total-line span:first-child {
            color: #0d47a1;
        }
        .theme-azul #total-line span#total {
            color: inherit; /* O #333 */
        /*
        }
        




        /* --- Estilos de Impresión --- */
        @media print {
            
            /*-- === INICIO:Estilos de imprecion Tema Azul Abstracto Pro (theme-azul) === --*/
            
            /* Ocultar elementos no deseados en impresión */
            .no-print { display: none !important; }



            /* --- Estilos Específicos para Impresión Tema Azul --- */
            

            /* Asegurar fondo del body para impresión */
            body.theme-azul {
                padding-top: 25px !important;  /* Espacio para header fijo */
                padding-bottom: 25px !important; /* Espacio para footer fijo */
                background-color: #eef5ff !important;
                -webkit-print-color-adjust: exact !important; /* !important añadido */
                print-color-adjust: exact !important; /* !important añadido */
            }

            body.theme-azul .print-footer {
                 background-color: #eef5ff !important; /* Fondo azul muy claro */
                 color: #0d47a1 !important; /* Texto azul oscuro */
                 border-top: 1px solid #42a5f5 !important; /* Borde azul claro */
                 /* Hereda otras propiedades de la regla base .print-footer como: */
                 display: block !important; 
                 padding: 10px 0 !important;
                 width: 100%;
                 font-size: 0.9em;
                 position: relative !important;
                 margin-top: 15px !important;
                 -webkit-print-color-adjust: exact !important; /* Asegurar colores */
                 print-color-adjust: exact !important;
            }



            /* Mostrar y posicionar el Header Azul */
            body.theme-azul #print-header-azul { /* Añadido body.theme-azul */
                display: block !important; /* Mostrar */
                height: 25px;
                background-color: #0d47a1 !important; /* !important añadido */
                width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 100; /* Z-index aumentado */
                -webkit-print-color-adjust: exact !important; /* !important añadido */
                print-color-adjust: exact !important; /* !important añadido */
                /* margin-bottom: 10px; */ /* No aplica con fixed */
            }
            
             /* Mostrar y posicionar el Footer Azul */
            body.theme-azul #print-footer-azul { /* Añadido body.theme-azul */
                display: block !important; /* Mostrar */
                height: 25px;
                background-color: #0d47a1 !important; /* !important añadido */
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 100; /* Z-index aumentado */
                -webkit-print-color-adjust: exact !important; /* !important añadido */
                print-color-adjust: exact !important; /* !important añadido */
                /* margin-top: 10px; */ /* No aplica con fixed */
            }

            
            /* Estilo del Círculo Decorativo (Solo en tema azul print) */
            body.theme-azul #print-header-azul .deco-circle {
                /* content: ''; */ /* 'content' no aplica a divs, solo a ::before/::after */
                position: absolute !important; /* Añadir !important por si acaso */
                top: 50% !important;
                transform: translateY(-50%) !important;
                left: 30px !important;
                width: 35px !important;
                height: 35px !important;
                background-color: #42a5f5 !important;
                border-radius: 50% !important;
                border: 4px solid #fff !important;
                z-index: 101 !important; /* Encima de la barra azul */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }



            /* Estilo del Rectángulo Sesgado (Solo en tema azul print) */
            body.theme-azul #print-footer-azul .deco-skew {
                /* content: ''; */ /* 'content' no aplica a divs */
                position: absolute !important; /* Añadir !important por si acaso */
                top: 50% !important;
                transform: translateY(-50%) skew(-20deg) !important;
                right: 30px !important;
                width: 60px !important;
                height: 20px !important;
                background-color: #1e88e5 !important;
                border: 4px solid #fff !important;
                z-index: 101 !important; /* Encima de la barra azul */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }



            /*-- === FIN:Estilos de imprecion Tema Azul Abstracto Pro (theme-azul) === --*/

            


            body {
                padding: 0 !important;
                margin: 0 !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact; print-color-adjust: exact; /* Importante para imprimir colores de fondo */
            }
            /* Fondo del body para tema púrpura en impresión */
            body.theme-purpura {
                 background-color: #f3e5f5 !important;
            }
             /* Fondo del body por defecto (blanco) en impresión */
             body:not(.theme-azul):not(.theme-purpura) {
                background-color: #fff !important;
            }
            

            .invoice-container {
                max-width: 100%; border: none; box-shadow: none; padding: 15px; margin: 0;
                border-radius: 0; /* Quitar bordes redondeados en impresión */
                overflow: visible; /* Resetear overflow */
                 background-color: #fff !important; /* Fondo siempre blanco para el contenedor principal en impresión */
            }
             /* Estilo base para el footer genérico */
            .print-footer {
                display: block !important; /* Mostrar por defecto */
                /* Mostrar por defecto (si no lo oculta una regla más específica como body.theme-azul .print-footer) */
                padding: 10px 0 !important;
                text-align: center;
                width: 100%;
                font-size: 0.9em;
                border: none !important; /* Quitar borde, se aplica por tema si es necesario */
                position: relative; /* No fijo */
                margin-top: 15px !important; /* Espacio antes del footer genérico */
                /* Los colores específicos del tema para el footer se aplican abajo */
            }
            /* Estilos de footer para TEMA PÚRPURA en impresión */
            .theme-purpura .print-footer {
                 background-color: #ab47bc !important; /* Púrpura */
                 color: #ffffff !important;
                 border-top: none !important;
                 print-color-adjust: exact;
            }
             .theme-purpura .print-footer p {
                  color: #ffffff !important;
             }



            thead { display: table-header-group; } /* Repetir cabecera de tabla en cada página */
            tbody tr, .invoice-summary, .invoice-note { page-break-inside: avoid; } /* Evitar cortes dentro de estos elementos */
            .no-print { display: none; } /* Ocultar elementos no deseados */
            * { box-shadow: none !important; } /* Quitar todas las sombras */
            .logo img { max-height: 60px; } /* Reducir tamaño logo si es necesario */


             /* (Opcional) Estilos específicos para TD en impresión si difieren */
             /* .theme-purpura .invoice-table td { ... } */

  


        }
        @page {
            padding-top: 1cm; /* Margen de página para impresión */
             padding-bottom: 1.2cm; /* Margen inferior un poco más grande para posible footer */
            /* Ajusta los márgenes si necesitas más espacio para header/footer */
            /* Ejemplo: margin-top: 4cm; margin-bottom: 4cm; */
            /* Sin embargo, esto NO pone los elementos ahí, solo reserva espacio */

         }

    </style>
</head>
<body class="bg-gray-100"> <!-- Clase base de Tailwind, será sobrescrita por JS si hay tema -->
    
    <!-- === INICIO: Encabezado Fijo para Impresión (Tema Azul) === -->
    <div id="print-header-azul" class="print-only theme-azul-print-header">
        <div class="deco-circle"></div> <!-- Elemento para el círculo decorativo -->
    </div>
    <!-- === FIN: Encabezado Fijo para Impresión === -->

     <!-- === INICIO: Pie de Página Fijo para Impresión (Tema Azul) === -->
    <div id="print-footer-azul" class="print-only theme-azul-print-footer">
        <div class="deco-skew"></div> <!-- Elemento para el rectángulo sesgado -->
    </div>
    <!-- === FIN: Pie de Página Fijo para Impresión === -->


    <!-- CONTENEDOR PRINCIPAL -->
    <div class="invoice-container">
        <div class="invoice-header">
            <div class="logo logo-left" id="logo1"></div>
            <div class="flex-grow text-center"></div>
            <div class="logo logo-right" id="logo2"></div>
        </div>


         


        <!-- Detalles Factura y De/Para -->
        <div class="invoice-details">
             <div id="factura-line" class="detail-line hidden"><strong>Factura #:</strong> <span id="factura"></span></div>
             <div id="fecha-line" class="detail-line hidden"><strong>Fecha:</strong> <span id="fecha"></span></div>
             <div id="hora-line" class="detail-line hidden"><strong>Hora:</strong> <span id="hora"></span></div>
        </div>
        <div class="sender-receiver-details">
            <div id="de-section" class="info-section hidden">
                <strong>De:</strong>
                <span id="de"></span>
            </div>
            <div id="para-section" class="info-section hidden">
                <strong>Para:</strong>
                <span id="para"></span>
            </div>
        </div>

        <!-- Tabla de Items -->
        <table class="invoice-table">
            <thead id="tabla-head"></thead>
            <tbody id="tabla-body"></tbody>
        </table>

        <!-- Resumen y Totales -->
        <div class="invoice-summary">
             <div id="subtotal-line" class="summary-line hidden">
                <span>Subtotal:</span>
                <span id="subtotal"></span>
            </div>
             <div id="iva-label-line" class="summary-line hidden">
                 <span>IVA:</span>
                 <span id="iva-label-value"></span>
             </div>
             <div id="iva-monto-line" class="summary-line hidden">
                 <span>Monto IVA:</span>
                 <span id="iva-monto-value"></span>
             </div>
            <div id="total-line" class="summary-line total-line hidden">
                <span>Total:</span>
                <span id="total"></span>
            </div>
        </div>

        <!-- Notas Adicionales -->
        <div class="invoice-note hidden" id="nota-section">
             <strong>Nota:</strong>
             <span id="nota"></span>
        </div>

    </div>

    <!-- PIE DE PÁGINA PARA IMPRESIÓN (Contenido se rellena con JS) -->
    <div class="print-footer" id="print-footer">
        <p>Gracias por su preferencia.</p>
        <p id="footer-company-info"></p>
        <p>Fecha de impresión: <span id="print-date"></span></p>
    </div>
    



    <script>
        document.addEventListener('DOMContentLoaded', function() {

            function getUrlParams() {
                const params = {};
                const urlParams = new URLSearchParams(window.location.search);
                params.columna = urlParams.getAll('columna');
                const uniqueKeys = new Set(urlParams.keys());
                uniqueKeys.forEach(key => {
                    // Decodificar todos los parámetros excepto 'columna' que ya se manejó
                    if (key !== 'columna') {
                        try {
                            // Decodificar también los valores de los parámetros que son nombres de columnas
                            // excepto si el parámetro es 'columna' mismo.
                            if (params.columna.includes(key) || !['columna'].includes(key)) {
                                params[key] = decodeURIComponent(urlParams.get(key));
                            } else {
                                params[key] = urlParams.get(key); // No decodificar 'columna' aquí
                            }
                        } catch (error) {
                            console.error(`Error decodificando parámetro '${key}':`, error);
                            params[key] = urlParams.get(key); // Usar valor sin decodificar en caso de error
                        }
                    }
                });

                // Ahora procesamos los datos de las columnas (que pueden contener comas)
                 if (params.columna.length > 0) {
                    params.columna.forEach(colName => {
                        if (urlParams.has(colName)) {
                             try {
                                // Estos sí pueden necesitar decodificación completa
                                params[colName] = decodeURIComponent(urlParams.get(colName));
                            } catch (error) {
                                console.error(`Error decodificando datos de columna '${colName}':`, error);
                                params[colName] = urlParams.get(colName);
                            }
                        } else {
                            params[colName] = ''; // Columna definida pero sin datos
                        }
                    });
                }

                return params;
            }

            function applyTheme(themeName) {
                // Limpiar clases de temas anteriores
                document.body.classList.remove('theme-purpura', 'theme-azul'); // Añadir más aquí si creas otros temas
                document.body.classList.remove('bg-gray-100'); // Limpiar fondo base
                // Aplicar la clase del tema nuevo si es válido
                if (themeName === 'PurpuraGrad') {
                    document.body.classList.add('theme-purpura');
                    
                } else if (themeName === 'AzulAbstractPro') { // <<< Añadir condición para el nuevo tema
                    document.body.classList.add('theme-azul');

                    // Sobrescribir la clase base de Tailwind si es necesario
                    document.body.classList.remove('bg-gray-100');
                } else {
                     // Si no hay tema o es inválido, asegurar que esté el fondo por defecto
                     document.body.classList.add('bg-gray-100'); // O la clase por defecto que uses

                }
            }


            function setElementTextAndVisibility(elementId, containerId, textContent) {
                const element = document.getElementById(elementId);
                const container = document.getElementById(containerId);
                if (!element || !container) {
                     return;
                }
                if (textContent && String(textContent).trim() !== '') { // Convertir a String por si acaso
                    element.textContent = textContent;
                    container.classList.remove('hidden');
                } else {
                    element.textContent = '';
                    container.classList.add('hidden');
                }
            }

            function setLogo(containerId, logoUrl) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                if (logoUrl && logoUrl.trim() !== '') {
                    const img = document.createElement('img');
                    img.src = logoUrl;
                    img.alt = "Logo";
                    container.appendChild(img);
                }
            }

            function populateInvoice() {
                const params = getUrlParams();
                console.log("Parámetros procesados:", params);

                // --- Aplicar Tema ---
                applyTheme(params.tema); // Llama a la función para aplicar el tema

                // --- Poblar Contenido ---
                setLogo('logo1', params.Logo1);
                setLogo('logo2', params.Logo2);

                setElementTextAndVisibility('factura', 'factura-line', params.Factura);
                setElementTextAndVisibility('fecha', 'fecha-line', params.Fecha);
                setElementTextAndVisibility('hora', 'hora-line', params.Hora);
                setElementTextAndVisibility('de', 'de-section', params.De);
                setElementTextAndVisibility('para', 'para-section', params.Para);

                const tableHead = document.getElementById('tabla-head');
                const tableBody = document.getElementById('tabla-body');
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                let calculatedTotal = 0;
                let amountColumnIndex = -1;

                if (params.columna && params.columna.length > 0) {
                    const headerRow = document.createElement('tr');
                    params.columna.forEach((colName, index) => {
                        const th = document.createElement('th');
                        // Usar el nombre de columna decodificado para el encabezado
                        th.textContent = colName; // Ya debería estar decodificado por getUrlParams
                        th.className = "px-2 py-2 " + (index === 0 ? "text-left" : "text-right");
                        headerRow.appendChild(th);
                         // Buscar columna 'monto' (insensible a mayúsculas/minúsculas)
                        if (typeof colName === 'string' && colName.toLowerCase() === 'monto') {
                           amountColumnIndex = index;
                        }
                    });
                    // Si no se encontró 'monto', usar la última columna como antes
                    if (amountColumnIndex === -1 && params.columna.length > 0) {
                       amountColumnIndex = params.columna.length - 1;
                    }
                    tableHead.appendChild(headerRow);

                    // Usar el nombre de la primera columna como clave para los datos de fila
                    const firstColName = params.columna[0];
                    // Asegurarse de que hay datos para la primera columna y no es solo una cadena vacía
                     if (params[firstColName] && String(params[firstColName]).trim() !== '') {
                        // Crear arrays de datos para cada columna, dividiendo por comas
                        const rowDataArrays = params.columna.map(colName =>
                            params[colName] ? String(params[colName]).split(',') : []
                        );

                        // Determinar el número de filas basado en la primera columna
                        const numRows = rowDataArrays.length > 0 ? rowDataArrays[0].length : 0;

                        // Validar consistencia (opcional pero bueno tenerlo)
                        const consistentData = rowDataArrays.every(arr => arr.length === numRows);
                        if (!consistentData) {
                            console.warn("Advertencia: Las columnas no tienen el mismo número de elementos. La tabla podría verse incompleta o desalineada.");
                        }

                        for (let i = 0; i < numRows; i++) {
                            const bodyRow = document.createElement('tr');
                            let rowAmount = 0;
                            params.columna.forEach((colName, j) => {
                                const td = document.createElement('td');
                                // Obtener el dato de la celda, asegurándose de que exista el array y el índice
                                const cellData = (rowDataArrays[j] && rowDataArrays[j][i] !== undefined)
                                                 ? String(rowDataArrays[j][i]).trim() // Convertir a string y quitar espacios
                                                 : '';
                                td.textContent = cellData;
                                td.className = "px-2 py-2 " + (j === 0 ? "text-left" : "text-right");
                                bodyRow.appendChild(td);

                                // Calcular total si es la columna de monto
                                if (j === amountColumnIndex) {
                                    // Limpiar el dato: quitar símbolos de moneda, espacios, usar punto como decimal
                                    const cleanedData = cellData.replace(/[^\d.,-]/g, '').replace(',', '.');
                                    const parsedAmount = parseFloat(cleanedData);
                                    if (!isNaN(parsedAmount)) {
                                        rowAmount = parsedAmount;
                                    } else {
                                        // console.warn(`No se pudo parsear el monto en fila ${i}, columna ${j}: '${cellData}'`);
                                    }
                                }
                            });
                            tableBody.appendChild(bodyRow);
                            calculatedTotal += rowAmount;
                        }
                    } else {
                         console.warn("No se encontraron datos para la primera columna ('" + firstColName + "') o está vacío. La tabla estará vacía.");
                         const emptyRow = tableBody.insertRow();
                         const emptyCell = emptyRow.insertCell();
                         emptyCell.colSpan = params.columna.length || 1; // Asegurar colspan > 0
                         emptyCell.textContent = "No hay elementos para mostrar.";
                         emptyCell.style.textAlign = "center";
                         emptyCell.style.padding = "20px";
                    }
                } else {
                     console.warn("No se especificaron columnas ('columna'). La tabla no se generará.");
                     const emptyRow = tableBody.insertRow();
                     const emptyCell = emptyRow.insertCell();
                     emptyCell.textContent = "No se ha definido la estructura de la tabla.";
                     emptyCell.style.textAlign = "center";
                     emptyCell.style.padding = "20px";
                }

                // --- Rellenar Resumen (Subtotal, IVA, Total) ---
                setElementTextAndVisibility('subtotal', 'subtotal-line', params.Subtotal);
                setElementTextAndVisibility('iva-label-value', 'iva-label-line', params.IVALine);
                setElementTextAndVisibility('iva-monto-value', 'iva-monto-line', params.IVAMonto);

                // Manejo Total (Prioriza parámetro 'Total', si no, usa calculado)
                // Formatear el total calculado a 2 decimales si se usa
                const formattedCalculatedTotal = calculatedTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const totalValue = (params.Total && String(params.Total).trim() !== '') ? params.Total : formattedCalculatedTotal;
                const totalElement = document.getElementById('total');
                const totalLineElement = document.getElementById('total-line');

                // Mostrar línea total si hay un Total explícito, o si hay Subtotal/IVA, o si el total calculado > 0
                const shouldShowTotal = (params.Total && String(params.Total).trim() !== '') ||
                                      (params.Subtotal && String(params.Subtotal).trim() !== '') ||
                                      (params.IVAMonto && String(params.IVAMonto).trim() !== '') ||
                                      (params.IVALine && String(params.IVALine).trim() !== '') || // También si solo dan % IVA
                                      calculatedTotal !== 0; // Mostrar si el cálculo dio algo (incluso negativo)

                if (shouldShowTotal) {
                    if (totalElement) totalElement.textContent = totalValue;
                    if (totalLineElement) totalLineElement.classList.remove('hidden');
                } else {
                    if (totalElement) totalElement.textContent = '';
                    if (totalLineElement) totalLineElement.classList.add('hidden');
                }

                // Rellenar Nota
                 setElementTextAndVisibility('nota', 'nota-section', params.Nota);

                 // Rellenar Pie de Impresión
                 const printFooterInfo = document.getElementById('footer-company-info');
                 const printDate = document.getElementById('print-date');

                 // Intentar obtener la segunda línea de 'De' para el footer
                 if (printFooterInfo && params.De) {
                     const deLines = String(params.De).split('\n');
                     printFooterInfo.textContent = (deLines.length > 1 ? deLines[1].trim() : deLines[0].trim()); // Segunda línea o primera si no hay segunda
                 } else if (printFooterInfo) {
                     printFooterInfo.textContent = ''; // Limpiar si no hay 'De'
                 }

                 if(printDate) {
                     const now = new Date();
                     const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
                     const timeOptions = { hour: '2-digit', minute: '2-digit' }; // Quitar segundos quizás
                     printDate.textContent = now.toLocaleDateString('es-ES', dateOptions) + ' ' + now.toLocaleTimeString('es-ES', timeOptions);
                 }
            }

            // Ejecutar la lógica principal
            populateInvoice();

            // Opcional: Impresión automática (descomentar si se necesita)
            // window.addEventListener('load', () => { setTimeout(window.print, 1500); }); // Dar un poco más de tiempo para renderizar

        });
    </script>
</body>
</html>
