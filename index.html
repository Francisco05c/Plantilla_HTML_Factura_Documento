<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura Dinámica v2.3 - Encabezado Reorganizado</title> <!-- Versión actualizada -->
    <!-- Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Estilos Base (Por Defecto) --- */

        /* Clase auxiliar para ocultar elementos en pantalla */
        .print-only {
            display: none;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f8f9fa; /* Fondo gris muy claro por defecto */
            transition: background-color 0.3s ease; /* Transición suave */
        }
        .invoice-container {
            max-width: 800px;
            margin: 20px auto;
            border: 1px solid #ddd;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background-color: #fff;
            position: relative; /* Necesario para ::before/::after del tema */
            overflow: hidden; /* Para contener ::before/::after dentro de bordes redondeados si los hay */
            transition: border 0.3s ease, box-shadow 0.3s ease; /* Transición suave */
        }

        /* === INICIO: Estilos de Encabezado Modificados === */
        .invoice-header {
            display: flex;
            justify-content: space-between; /* Empuja izquierda y derecha a los extremos */
            align-items: flex-start; /* Alinea los items al inicio (arriba) */
            margin-bottom: 25px; /* Aumentar un poco el margen inferior */
            min-height: 60px; /* Mantener altura mínima */
            position: relative;
            z-index: 1;
            gap: 20px; /* Espacio entre el bloque de logos y el bloque de detalles */
        }

        .header-left {
            display: flex; /* Coloca logos uno al lado del otro */
            align-items: center; /* Centra verticalmente los logos entre sí */
            gap: 15px; /* Espacio entre logo1 y logo2 si ambos existen */
            flex-shrink: 0; /* Evita que los logos se encojan demasiado */
        }

        .header-right {
            text-align: right; /* Alinea el texto de Factura/Fecha/Hora a la derecha */
            flex-shrink: 1; /* Permite que esta sección se encoja si falta espacio */
            padding-top: 5px; /* Pequeño ajuste vertical si es necesario */
        }

        /* Estilos para las líneas de detalle DENTRO del header-right */
        .header-right .detail-line {
            margin-bottom: 3px; /* Espacio pequeño entre líneas */
            font-size: 0.9em; /* Opcional: Hacer texto un poco más pequeño */
        }
        .header-right .detail-line.hidden {
             display: none; /* Asegura que el JS pueda ocultarlos */
        }
         .header-right .detail-line:last-child {
             margin-bottom: 0; /* Sin margen inferior en la última línea */
         }

        .logo { /* Contenedor del logo */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo img {
            max-width: 130px; /* Ajustar según necesidad */
            max-height: 130px; /* Ajustar según necesidad */
            object-fit: contain;
            display: block; /* Evita espacio extra debajo de la imagen */
        }
        /* Oculta el contenedor del logo si está vacío (JS no añadió <img>) */
        .logo:empty {
            display: none;
        }

        #logo2 { /* Apunta directamente al contenedor del logo 2 */
        width: 300px; /* El doble del ancho del logo 1 (130px * 2) */
        max-height: 130px;
        }
        #logo2 img {
        max-width: 100%; /* Permite que la imagen use el ancho del contenedor */
        }

        /* === FIN: Estilos de Encabezado Modificados === */

        .company-info { /* Usado para "De:" - NO ESTÁ PRESENTE EN TU HTML INICIAL */
            /* Si lo necesitas, defínelo aquí */
            /* text-align: left; */
            /* flex: 1; */
            /* margin: 0 20px; */
            /* white-space: pre-wrap; */
        }

        /* Detalles De/Para (Ya no contiene Factura/Fecha/Hora) */
        .sender-receiver-details {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        /* Ocultar elementos si JS añade la clase hidden */
        .detail-line.hidden, .info-section.hidden {
            display: none;
        }

        .info-section { /* Para De: y Para: */
            flex: 1;
            min-width: 250px;
        }
        .info-section strong {
            display: block;
            margin-bottom: 5px;
        }
        .info-section span {
             white-space: pre-wrap;
             display: block;
        }
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            position: relative; /* Para que esté por encima de ::before */
            z-index: 1;
        }
        .invoice-table th, .invoice-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
            text-align: right;
            vertical-align: top;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; /* Transición suave */
        }
        .invoice-table th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        .invoice-table th.text-left, .invoice-table td.text-left {
            text-align: left;
        }
        .invoice-summary {
            margin-left: auto;
            width: 300px; /* O usar clases Tailwind w- */
            position: relative; /* Para que esté por encima de ::after */
            z-index: 1;
        }
        .invoice-summary div.summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .invoice-summary div.summary-line.hidden {
             display: none;
        }
        .invoice-summary .total-line {
            font-weight: bold;
            font-size: 1.1em;
            border-top: 2px solid #333;
            padding-top: 8px;
            margin-top: 5px;
             transition: border-color 0.3s ease, color 0.3s ease; /* Transición suave */
        }
        .invoice-note {
            margin-top: 30px;
            font-style: italic;
             white-space: pre-wrap;
             border-top: 1px solid #eee;
             padding-top: 15px;
             position: relative; /* Para que esté por encima de ::after */
             z-index: 1;
        }
        .invoice-note.hidden { display: none; }
         .invoice-note strong {
             display: block;
             margin-bottom: 5px;
             font-style: normal;
         }
        .print-footer {
            display: none; /* Oculto por defecto, visible en impresión */
            padding: 10px 0;
            text-align: center;
            width: 100%;
            position: relative;
            border-top: 1px solid #ddd;
            margin-top: 20px;
            font-size: 0.9em;
            background-color: #fff; /* Fondo blanco por defecto para impresión */
            color: #333; /* Texto oscuro por defecto */
             transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; /* Transición suave */
        }

        /* --- Estilos Tema Púrpura Gradiente (PurpuraGrad) --- */
        body.theme-purpura {
            background-color: #f3e5f5; /* Fondo general lila claro */
        }
        /* === Aplicar color púrpura a etiquetas específicas (incluyendo las movidas) === */
        .theme-purpura .header-right #factura-line strong, /* Modificado */
        .theme-purpura .header-right #fecha-line strong,  /* Modificado */
        .theme-purpura .header-right #hora-line strong,   /* Modificado */
        .theme-purpura #de-section strong,
        .theme-purpura #para-section strong {
            color: #8e24aa; /* Púrpura oscuro (mismo que th) */
        }
        .theme-purpura .invoice-container {
            border: 1px solid #ab47bc; /* Borde púrpura */
            background-color: #fff; /* Fondo blanco */
            box-shadow: 0 0 20px rgba(171, 71, 188, 0.2); /* Sombra púrpura suave */
            border-radius: 8px; /* Bordes redondeados */
        }
        .theme-purpura .invoice-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to bottom, rgba(206, 147, 216, 0.6), rgba(206, 147, 216, 0));
            border-radius: 8px 8px 0 0;
            z-index: 0;
            pointer-events: none;
        }
        .theme-purpura .invoice-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to top, rgba(206, 147, 216, 0.7), rgba(206, 147, 216, 0));
            border-radius: 0 0 8px 8px;
            z-index: 0;
            opacity: 0.8;
            pointer-events: none;
        }
        .theme-purpura .invoice-table th {
            background-color: #e1bee7; /* Lila muy claro */
            color: #8e24aa; /* Púrpura oscuro para texto */
            border-bottom: 1px solid #ce93d8; /* Lila medio */
        }
        .theme-purpura .invoice-table td {
            border-bottom: 1px solid #f3e5f5; /* Lila muy, muy claro */
        }
        .theme-purpura .invoice-summary .total-line {
            border-top: 2px solid #ab47bc; /* Púrpura principal */
            color: #8e24aa; /* Púrpura oscuro */
        }
        .theme-purpura .print-footer {
            background-color: #ab47bc; /* Púrpura principal */
            color: #ffffff; /* Texto blanco */
            border-top: none;
        }
        .theme-purpura .print-footer p {
             color: #ffffff;
        }


        /* --- Estilos Tema Azul Abstracto Pro (theme-azul) --- */
        body.theme-azul {
            background-color: #eef5ff;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

         /* Etiquetas (Factura, Fecha, Hora, De, Para) */
         .theme-azul .header-right #factura-line strong, /* Modificado */
         .theme-azul .header-right #fecha-line strong,  /* Modificado */
         .theme-azul .header-right #hora-line strong,   /* Modificado */
         .theme-azul #de-section strong,
         .theme-azul #para-section strong {
            color: #0d47a1; /* Azul Oscuro */
        }

        .theme-azul .invoice-container {
            border: none;
            box-shadow: 0 4px 15px rgba(0, 50, 150, 0.15);
            padding-top: 20px;
            padding-bottom: 20px;
            background-color: #fff;
            position: relative;
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .theme-azul .invoice-table th {
            background-color: #1e88e5; /* Azul intermedio */
            color: #ffffff; /* Texto blanco */
            border-bottom: 1px solid #1565c0; /* Borde azul más oscuro */
        }
        .theme-azul .invoice-table td {
            border-bottom: 1px solid #bbdefb; /* Borde azul muy claro */
        }
        .theme-azul .invoice-summary .total-line {
            border-top: 2px solid #0d47a1; /* Borde azul oscuro */
            color: #0d47a1; /* Color texto azul oscuro */
        }


        /* --- Estilos de Impresión --- */
        @media print {
             .no-print { display: none !important; }
            /* --- Estilos Específicos para Impresión Tema Azul --- */
            body.theme-azul {
                padding-top: 25px !important;
                padding-bottom: 25px !important;
                background-color: #eef5ff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body.theme-azul .print-footer {
                 background-color: #eef5ff !important;
                 color: #0d47a1 !important;
                 border-top: 1px solid #42a5f5 !important;
                 display: block !important;
                 padding: 10px 0 !important;
                 width: 100%;
                 font-size: 0.9em;
                 position: relative !important;
                 margin-top: 15px !important;
                 -webkit-print-color-adjust: exact !important;
                 print-color-adjust: exact !important;
            }
            body.theme-azul #print-header-azul {
                display: block !important;
                height: 25px;
                background-color: #0d47a1 !important;
                width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1000; /* Aumentado z-index */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
             body.theme-azul #print-footer-azul {
                display: block !important;
                height: 25px;
                background-color: #0d47a1 !important;
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 1000; /* Aumentado z-index */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body.theme-azul #print-header-azul .deco-circle {
                position: absolute !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                left: 30px !important;
                width: 35px !important;
                height: 35px !important;
                background-color: #42a5f5 !important;
                border-radius: 50% !important;
                border: 4px solid #fff !important;
                z-index: 1001; /* Encima de la barra */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body.theme-azul #print-footer-azul .deco-skew {
                position: absolute !important;
                top: 50% !important;
                transform: translateY(-50%) skew(-20deg) !important;
                right: 30px !important;
                width: 60px !important;
                height: 20px !important;
                background-color: #1e88e5 !important;
                border: 4px solid #fff !important;
                z-index: 1001; /* Encima de la barra */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            /* --- FIN Impresión Tema Azul --- */

            /* --- Estilos Generales Impresión --- */
            body {
                padding: 0 !important; margin: 0 !important; color: #000 !important;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            body.theme-purpura { background-color: #f3e5f5 !important; }
            body:not(.theme-azul):not(.theme-purpura) { background-color: #fff !important; }

            .invoice-container {
                max-width: 100%; border: none; box-shadow: none; padding: 15px; margin: 0;
                border-radius: 0; overflow: visible; background-color: #fff !important;
            }
            .print-footer { /* Estilo base footer genérico */
                display: block !important; padding: 10px 0 !important; text-align: center; width: 100%;
                font-size: 0.9em; border: none !important; position: relative; margin-top: 15px !important;
            }
             /* Estilos footer para TEMA PÚRPURA en impresión */
            .theme-purpura .print-footer {
                 background-color: #ab47bc !important; color: #ffffff !important;
                 border-top: none !important; print-color-adjust: exact;
            }
             .theme-purpura .print-footer p { color: #ffffff !important; }

            thead { display: table-header-group; }
            tbody tr, .invoice-summary, .invoice-note { page-break-inside: avoid; }
            .no-print { display: none; }
            * { box-shadow: none !important; }
            .logo img { max-height: 50px; } /* Reducir un poco más logo en impresión */
        }
        @page {
             margin-top: 1cm; /* Reducido margen superior */
             margin-bottom: 1cm; /* Reducido margen inferior */
             /* Si usas los headers/footers fijos del tema azul, ajusta estos márgenes */
            /* Ejemplo para tema azul: */
            /* @page { margin-top: 35px; margin-bottom: 35px; } */
         }

    </style>
</head>
<body class="bg-gray-100"> <!-- Clase base, sobrescrita por JS -->

    <!-- Encabezado/Pie Fijo para Impresión (Tema Azul) -->
    <div id="print-header-azul" class="print-only theme-azul-print-header">
        <div class="deco-circle"></div>
    </div>
    <div id="print-footer-azul" class="print-only theme-azul-print-footer">
        <div class="deco-skew"></div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="invoice-container">
        <!-- === INICIO: Encabezado Modificado === -->
        <div class="invoice-header">
            <!-- Logos a la izquierda -->
            <div class="header-left">
                <div class="logo" id="logo1"></div> <!-- Logo 1 siempre aquí -->
                <div class="logo" id="logo2"></div> <!-- Logo 2 al lado derecho de logo 1 -->
            </div>
            <!-- Detalles de Factura a la derecha -->
            <div class="header-right">
                 <div id="factura-line" class="detail-line hidden"><strong>Factura #:</strong> <span id="factura"></span></div>
                 <div id="fecha-line" class="detail-line hidden"><strong>Fecha:</strong> <span id="fecha"></span></div>
                 <div id="hora-line" class="detail-line hidden"><strong>Hora:</strong> <span id="hora"></span></div>
            </div>
        </div>
        <!-- === FIN: Encabezado Modificado === -->

        <!-- Detalles De/Para (Ahora sin Factura/Fecha/Hora) -->
        <div class="sender-receiver-details">
            <div id="de-section" class="info-section hidden">
                <strong>De:</strong>
                <span id="de"></span>
            </div>
            <div id="para-section" class="info-section hidden">
                <strong>Para:</strong>
                <span id="para"></span>
            </div>
        </div>

        <!-- Tabla de Items (Sin cambios) -->
        <table class="invoice-table">
            <thead id="tabla-head"></thead>
            <tbody id="tabla-body"></tbody>
        </table>

        <!-- Resumen y Totales (Sin cambios) -->
        <div class="invoice-summary">
             <div id="subtotal-line" class="summary-line hidden">
                <span>Subtotal:</span>
                <span id="subtotal"></span>
            </div>
             <div id="iva-label-line" class="summary-line hidden">
                 <span>IVA:</span>
                 <span id="iva-label-value"></span>
             </div>
             <div id="iva-monto-line" class="summary-line hidden">
                 <span>Monto IVA:</span>
                 <span id="iva-monto-value"></span>
             </div>
            <div id="total-line" class="summary-line total-line hidden">
                <span>Total:</span>
                <span id="total"></span>
            </div>
        </div>

        <!-- Notas Adicionales (Sin cambios) -->
        <div class="invoice-note hidden" id="nota-section">
             <strong>Nota:</strong>
             <span id="nota"></span>
        </div>

    </div>

    <!-- PIE DE PÁGINA PARA IMPRESIÓN (Contenido se rellena con JS) -->
    <div class="print-footer" id="print-footer">
        <p>Gracias por su preferencia.</p>
        <p id="footer-company-info"></p>
        <p>Fecha de impresión: <span id="print-date"></span></p>
    </div>

    <script>
        // --- EL CÓDIGO JAVASCRIPT NO NECESITA CAMBIOS ---
        // Sigue funcionando igual porque los IDs de los elementos (#logo1, #logo2, #factura, #fecha, #hora, etc.)
        // y los IDs de las líneas/contenedores que se ocultan/muestran
        // (#factura-line, #fecha-line, #hora-line, #de-section, #para-section, etc.) se han mantenido.
        // La lógica de getUrlParams, applyTheme, setElementTextAndVisibility, setLogo y populateInvoice
        // sigue siendo válida.

        document.addEventListener('DOMContentLoaded', function() {

            function getUrlParams() {
                const params = {};
                const urlParams = new URLSearchParams(window.location.search);
                params.columna = urlParams.getAll('columna');
                const uniqueKeys = new Set(urlParams.keys());
                uniqueKeys.forEach(key => {
                    if (key !== 'columna') {
                        try {
                             params[key] = decodeURIComponent(urlParams.get(key));
                         } catch (error) {
                            console.error(`Error decodificando parámetro '${key}':`, error);
                            params[key] = urlParams.get(key);
                        }
                    }
                });

                 if (params.columna.length > 0) {
                    params.columna.forEach(colName => {
                        if (urlParams.has(colName)) {
                             try {
                                params[colName] = decodeURIComponent(urlParams.get(colName));
                            } catch (error) {
                                console.error(`Error decodificando datos de columna '${colName}':`, error);
                                params[colName] = urlParams.get(colName);
                            }
                        } else {
                            params[colName] = '';
                        }
                    });
                }
                return params;
            }

            function applyTheme(themeName) {
                document.body.classList.remove('theme-purpura', 'theme-azul', 'bg-gray-100');
                if (themeName === 'PurpuraGrad') {
                    document.body.classList.add('theme-purpura');
                } else if (themeName === 'AzulAbstractPro') {
                    document.body.classList.add('theme-azul');
                } else {
                     document.body.classList.add('bg-gray-100');
                }
            }

            function setElementTextAndVisibility(elementId, containerId, textContent) {
                const element = document.getElementById(elementId);
                const container = document.getElementById(containerId);
                 // console.log("Setting visibility for:", containerId, "with content:", textContent); // Debug
                 if (!element || !container) {
                     // console.warn("Element or container not found:", elementId, containerId); // Debug
                     return;
                 }
                if (textContent && String(textContent).trim() !== '') {
                    element.textContent = textContent;
                    container.classList.remove('hidden');
                    // console.log("Showing:", containerId); // Debug
                 } else {
                    element.textContent = '';
                    container.classList.add('hidden');
                     // console.log("Hiding:", containerId); // Debug
                 }
            }

            function setLogo(containerId, logoUrl) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = ''; // Limpiar siempre por si acaso
                if (logoUrl && logoUrl.trim() !== '') {
                    const img = document.createElement('img');
                    img.src = logoUrl;
                    img.alt = "Logo";
                    container.appendChild(img);
                     // console.log("Logo set for:", containerId); // Debug
                 } else {
                     // console.log("No logo for:", containerId); // Debug
                     // No es necesario añadir la clase hidden aquí,
                     // el CSS con :empty debería encargarse si el contenedor está vacío.
                     // container.classList.add('hidden'); // Opcional: Añadir hidden explícitamente
                 }
            }

            function populateInvoice() {
                const params = getUrlParams();
                console.log("Parámetros procesados:", params);
                // Reemplaza estas URLs con las rutas correctas a tus logos por defecto
                const defaultLogo1Url = 'https://cdn.discordapp.com/attachments/925921694332375073/1358565361456513034/Sin_titulo-2_svg_formato.svg?ex=67f44e17&is=67f2fc97&hm=6145e1c5aac7127ee713c67d683bb3c386452b0a34ca150f20aeca63066e639e&';
                const defaultLogo2Url = 'https://cdn.discordapp.com/attachments/925921694332375073/1358565361779343500/Sin_titulo-3.svg?ex=67f44e17&is=67f2fc97&hm=70d75ef8864f02fa3851fa16942c2504a05627d611a86b42473de5e2c995762e&';
                // Ejemplo con rutas relativas (si las imágenes están en una carpeta 'img'):
                // const defaultLogo1Url = 'img/logo-empresa-defecto.png';
                // const defaultLogo2Url = 'img/logo-secundario-defecto.svg';
                applyTheme(params.tema);

                const logo1UrlToUse = (params.Logo1 && String(params.Logo1).trim() !== '')
                                      ? params.Logo1  // Usar parámetro si existe y no está vacío
                                      : defaultLogo1Url; // Si no, usar el default

                const logo2UrlToUse = (params.Logo2 && String(params.Logo2).trim() !== '')
                                      ? params.Logo2  // Usar parámetro si existe y no está vacío
                                      : defaultLogo2Url; // Si no, usar el default


                                      setLogo('logo1', logo1UrlToUse);
                                      setLogo('logo2', logo2UrlToUse);

                setElementTextAndVisibility('factura', 'factura-line', params.Factura);
                setElementTextAndVisibility('fecha', 'fecha-line', params.Fecha);
                setElementTextAndVisibility('hora', 'hora-line', params.Hora);
                setElementTextAndVisibility('de', 'de-section', params.De);
                setElementTextAndVisibility('para', 'para-section', params.Para);

                const tableHead = document.getElementById('tabla-head');
                const tableBody = document.getElementById('tabla-body');
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                let calculatedTotal = 0;
                let amountColumnIndex = -1;

                if (params.columna && params.columna.length > 0) {
                    const headerRow = document.createElement('tr');
                    params.columna.forEach((colName, index) => {
                        const th = document.createElement('th');
                        th.textContent = colName;
                        th.className = "px-2 py-2 " + (index === 0 ? "text-left" : "text-right");
                        headerRow.appendChild(th);
                        if (typeof colName === 'string' && colName.toLowerCase() === 'monto') {
                           amountColumnIndex = index;
                        }
                    });
                    if (amountColumnIndex === -1 && params.columna.length > 0) {
                       amountColumnIndex = params.columna.length - 1;
                    }
                    tableHead.appendChild(headerRow);

                    const firstColName = params.columna[0];
                     if (params[firstColName] && String(params[firstColName]).trim() !== '') {
                        const rowDataArrays = params.columna.map(colName =>
                            params[colName] ? String(params[colName]).split(',') : []
                        );
                        const numRows = rowDataArrays.length > 0 ? rowDataArrays[0].length : 0;
                        const consistentData = rowDataArrays.every(arr => arr.length === numRows);
                        if (!consistentData) {
                            console.warn("Advertencia: Las columnas no tienen el mismo número de elementos.");
                        }

                        for (let i = 0; i < numRows; i++) {
                            const bodyRow = document.createElement('tr');
                            let rowAmount = 0;
                            params.columna.forEach((colName, j) => {
                                const td = document.createElement('td');
                                const cellData = (rowDataArrays[j] && rowDataArrays[j][i] !== undefined)
                                                 ? String(rowDataArrays[j][i]).trim()
                                                 : '';
                                td.textContent = cellData;
                                td.className = "px-2 py-2 " + (j === 0 ? "text-left" : "text-right");
                                bodyRow.appendChild(td);

                                if (j === amountColumnIndex) {
                                    const cleanedData = cellData.replace(/[^\d.,-]/g, '').replace(',', '.');
                                    const parsedAmount = parseFloat(cleanedData);
                                    if (!isNaN(parsedAmount)) {
                                        rowAmount = parsedAmount;
                                    }
                                }
                            });
                            tableBody.appendChild(bodyRow);
                            calculatedTotal += rowAmount;
                        }
                    } else {
                         console.warn("No se encontraron datos para la primera columna ('" + firstColName + "') o está vacío.");
                         const emptyRow = tableBody.insertRow();
                         const emptyCell = emptyRow.insertCell();
                         emptyCell.colSpan = params.columna.length || 1;
                         emptyCell.textContent = "No hay elementos para mostrar.";
                         emptyCell.style.textAlign = "center";
                         emptyCell.style.padding = "20px";
                    }
                } else {
                     console.warn("No se especificaron columnas ('columna').");
                     const emptyRow = tableBody.insertRow();
                     const emptyCell = emptyRow.insertCell();
                     emptyCell.textContent = "No se ha definido la estructura de la tabla.";
                     emptyCell.style.textAlign = "center";
                     emptyCell.style.padding = "20px";
                }

                setElementTextAndVisibility('subtotal', 'subtotal-line', params.Subtotal);
                setElementTextAndVisibility('iva-label-value', 'iva-label-line', params.IVALine);
                setElementTextAndVisibility('iva-monto-value', 'iva-monto-line', params.IVAMonto);

                const formattedCalculatedTotal = calculatedTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const totalValue = (params.Total && String(params.Total).trim() !== '') ? params.Total : formattedCalculatedTotal;
                const totalElement = document.getElementById('total');
                const totalLineElement = document.getElementById('total-line');
                const shouldShowTotal = (params.Total && String(params.Total).trim() !== '') ||
                                      (params.Subtotal && String(params.Subtotal).trim() !== '') ||
                                      (params.IVAMonto && String(params.IVAMonto).trim() !== '') ||
                                      (params.IVALine && String(params.IVALine).trim() !== '') ||
                                      calculatedTotal !== 0;
                if (shouldShowTotal) {
                    if (totalElement) totalElement.textContent = totalValue;
                    if (totalLineElement) totalLineElement.classList.remove('hidden');
                } else {
                    if (totalElement) totalElement.textContent = '';
                    if (totalLineElement) totalLineElement.classList.add('hidden');
                }

                 setElementTextAndVisibility('nota', 'nota-section', params.Nota);

                 const printFooterInfo = document.getElementById('footer-company-info');
                 const printDate = document.getElementById('print-date');
                 if (printFooterInfo && params.De) {
                     const deLines = String(params.De).split('\n');
                     printFooterInfo.textContent = (deLines.length > 1 ? deLines[1].trim() : deLines[0].trim());
                 } else if (printFooterInfo) {
                     printFooterInfo.textContent = '';
                 }
                 if(printDate) {
                     const now = new Date();
                     const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
                     const timeOptions = { hour: '2-digit', minute: '2-digit' };
                     printDate.textContent = now.toLocaleDateString('es-ES', dateOptions) + ' ' + now.toLocaleTimeString('es-ES', timeOptions);
                 }
            }

            populateInvoice();
            // Opcional: Impresión automática
            // window.addEventListener('load', () => { setTimeout(window.print, 1500); });

        });
    </script>
</body>
</html>
