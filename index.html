<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura Dinámica v2.4 - Generación Limpia</title>
    <!-- Tailwind CSS (Opcional, si se usa para alguna utilidad rápida, aunque el core es CSS puro) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Estilos Base (Default Theme) --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0; /* Padding gestionado por temas o impresión */
            color: #333;
            background-color: #f8f9fa; /* Default BG */
            transition: background-color 0.3s ease;
            min-height: 100vh; /* Asegura que el body ocupe al menos la altura de la ventana */
        }

        .invoice-wrapper { /* Contenedor para padding general en pantalla */
             padding: 20px;
        }

        .invoice-container {
            max-width: 800px;
            margin: 0 auto; /* Centrado dentro del wrapper */
            border: 1px solid #ddd; /* Default Border */
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); /* Default Shadow */
            background-color: #fff; /* Default BG */
            position: relative;
            overflow: hidden; /* Para contener gradientes ::before/::after */
            transition: border 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }

        /* --- Clases Utilitarias --- */
        .hidden { display: none !important; } /* Para JS */
        .print-only { display: none; } /* Oculto en pantalla */
        .screen-only-decoration { display: none; } /* Oculto por defecto (pantalla/impresión) */
        .no-print { /* Para ocultar elementos específicos en impresión */
             /* No se usa activamente aquí, pero útil tenerla */
        }

        /* --- Estructura: Encabezado Reorganizado --- */
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            min-height: 60px;
            position: relative;
            z-index: 1;
            gap: 20px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }
        .header-right {
            text-align: right;
            flex-shrink: 1;
            padding-top: 5px;
        }
        .header-right .detail-line {
            margin-bottom: 3px;
            /* AUMENTO DE TAMAÑO DE TEXTO DEL ENCABEZADO DERECHO */
            font-size: 1em; /* Antes era 0.9em */
        }
        .header-right .detail-line strong {
            color: #333; /* Color base, sobrescrito por temas */
            transition: color 0.3s ease;
        }
        .header-right .detail-line:last-child { margin-bottom: 0; }

        /* --- Estructura: Logos --- */
        .logo { display: flex; align-items: center; }
        .logo img {
            max-width: 130px;
            max-height: 130px;
            object-fit: contain;
            display: block;
        }
        .logo:empty { display: none; } /* Oculta si JS no pone imagen */
        #logo2 img { max-width: 300px; } /* Permite logo 2 más ancho */

        /* --- Estructura: Detalles De/Para --- */
        .sender-receiver-details {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }
        .info-section { flex: 1; min-width: 250px; }
        .info-section strong.dynamic-label { /* Estilo para etiquetas dinámicas (De:, Para:) */
            display: inline; /* Para que esté en la misma línea que el texto siguiente si es corto */
            margin-bottom: 0; /* No necesita margen si es inline */
            color: #333; /* Color base, sobrescrito por temas */
            transition: color 0.3s ease;
            font-weight: bold; /* Asegurar que sea bold */
        }
        /* Si el tema aplica color a .info-section strong, también lo hará a .dynamic-label */
        .theme-purpura .info-section strong.dynamic-label { color: #8e24aa; }
        .theme-azul .info-section strong.dynamic-label { color: #0d47a1; }

        .info-section span { white-space: pre-wrap; display: block; }
        /* Ajuste para que el span que contiene el contenido estilizado de De/Para se comporte bien */
        .info-section span#de, .info-section span#para {
            display: block; /* Mantiene el comportamiento de bloque para múltiples líneas */
        }


        /* --- Estructura: Tabla --- */
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        .invoice-table th, .invoice-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd; /* Default border */
            text-align: right;
            vertical-align: top;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .invoice-table th {
            background-color: #f8f8f8; /* Default header BG */
            font-weight: bold;
            color: #333; /* Default header text */
        }
        .invoice-table th.text-left, .invoice-table td.text-left { text-align: left; }

        /* --- Estructura: Resumen --- */
        .invoice-summary {
            margin-left: auto;
            width: 300px;
            position: relative;
            z-index: 1;
        }
        .invoice-summary .summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .invoice-summary .total-line {
            font-weight: bold;
            font-size: 1.1em;
            border-top: 2px solid #333; /* Default total border */
            padding-top: 8px;
            margin-top: 5px;
            color: #333; /* Default total text */
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        /* --- Estructura: Notas --- */
        .invoice-note {
            margin-top: 30px;
            font-style: italic;
            white-space: pre-wrap;
            border-top: 1px solid #eee;
            padding-top: 15px;
            position: relative;
            z-index: 1;
        }
        .invoice-note strong {
            display: block;
            margin-bottom: 5px;
            font-style: normal;
        }

        /* --- Estructura: Pie de Página (Impresión Genérico) --- */
        .print-footer {
            display: none; /* Visible solo en impresión por @media print */
            padding: 10px 0;
            text-align: center;
            width: 100%;
            position: relative; /* Fluye al final del contenido en impresión */
            margin-top: 20px;
            font-size: 0.9em;
            background-color: #fff; /* Default BG */
            color: #333; /* Default text */
            border-top: 1px solid #ddd; /* Default border */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .print-footer p { margin: 2px 0; }

        /* === TEMA: Púrpura Gradiente === */
        body.theme-purpura { background-color: #f3e5f5; }
        .theme-purpura .invoice-container {
            border: 1px solid #ab47bc;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(171, 71, 188, 0.2);
            border-radius: 8px;
        }
        .theme-purpura .invoice-container::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 10px;
            background: linear-gradient(to bottom, rgba(206, 147, 216, 0.6), rgba(206, 147, 216, 0));
            border-radius: 8px 8px 0 0; z-index: 0; pointer-events: none;
        }
        .theme-purpura .invoice-container::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 50px;
            background: linear-gradient(to top, rgba(206, 147, 216, 0.7), rgba(206, 147, 216, 0));
            border-radius: 0 0 8px 8px; z-index: 0; opacity: 0.8; pointer-events: none;
        }
        .theme-purpura .header-right strong,
        .theme-purpura .info-section strong { color: #8e24aa; } /* Esto afectará a .dynamic-label también */
        .theme-purpura .invoice-table th {
            background-color: #e1bee7; color: #8e24aa; border-bottom: 1px solid #ce93d8;
        }
        .theme-purpura .invoice-table td { border-bottom: 1px solid #f3e5f5; }
        .theme-purpura .invoice-summary .total-line { border-top: 2px solid #ab47bc; color: #8e24aa; }
        .theme-purpura .print-footer { /* Estilos específicos impresión */
             background-color: #ab47bc; color: #ffffff; border-top: none;
        }
        .theme-purpura .print-footer p { color: #ffffff; }

        /* === TEMA: Azul Abstracto Pro === */
        body.theme-azul { background-color: #eef5ff; }
        .theme-azul .invoice-container {
            border: none;
            box-shadow: 0 4px 15px rgba(0, 50, 150, 0.15);
            background-color: #fff;
        }
        .theme-azul .header-right strong,
        .theme-azul .info-section strong { color: #0d47a1; } /* Esto afectará a .dynamic-label también */
        .theme-azul .invoice-table th {
            background-color: #1e88e5; color: #ffffff; border-bottom: 1px solid #1565c0;
        }
        .theme-azul .invoice-table td { border-bottom: 1px solid #bbdefb; }
        .theme-azul .invoice-summary .total-line { border-top: 2px solid #0d47a1; color: #0d47a1; }
        .theme-azul .print-footer { /* Estilos específicos impresión */
             background-color: #eef5ff; color: #0d47a1; border-top: 1px solid #42a5f5;
        }
        .theme-azul .print-footer p { color: #0d47a1; }


        /* === TEMA: Azul Abstracto Pro HF (Decoraciones) === */
        #print-header-azul, #print-footer-azul {
            height: 25px; background-color: #0d47a1; width: 100%;
            position: fixed; left: 0; z-index: 1000;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        #print-header-azul { top: 0; }
        #print-footer-azul { bottom: 0; }
        #print-header-azul .deco-circle, #print-footer-azul .deco-skew {
             position: absolute; top: 50%; border: 4px solid #fff; z-index: 1001;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        #print-header-azul .deco-circle {
            transform: translateY(-50%); left: 30px; width: 35px; height: 35px;
            background-color: #42a5f5; border-radius: 50%;
        }
        #print-footer-azul .deco-skew {
             transform: translateY(-50%) skew(-20deg); right: 30px; width: 60px; height: 20px;
             background-color: #1e88e5;
        }
        #screen-header-azul, #screen-footer-azul {
            height: 25px; background-color: #0d47a1; margin-left: -30px; margin-right: -30px;
            position: relative; overflow: hidden;
        }
        #screen-header-azul {
            margin-top: -30px; 
            margin-bottom: 20px; 
        }
        #screen-footer-azul{
            margin-bottom: -30px; 
            margin-top: 20px; 
        }
        #screen-header-azul .deco-circle, #screen-footer-azul .deco-skew {
             position: absolute; top: 50%; border: 4px solid #fff; z-index: 1;
        }
        #screen-header-azul .deco-circle {
            transform: translateY(-50%); left: 30px; width: 35px; height: 35px;
            background-color: #42a5f5; border-radius: 50%;
        }
        #screen-footer-azul .deco-skew {
            transform: translateY(-50%) skew(-20deg); right: 30px; width: 60px; height: 20px;
            background-color: #1e88e5;
        }
        body.use-hf-azul .screen-only-decoration {
             display: block;
        }


        /* --- Estilos de Impresión --- */
        @media print {
            body {
                margin: 0 !important;
                padding: 0 !important; 
                color: #000 !important;
                background-color: #fff !important; 
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            body.theme-purpura { background-color: #f3e5f5 !important; }
            body.theme-azul { background-color: #eef5ff !important; }
            body.use-hf-azul {
                 padding-top: 35px !important; 
                 padding-bottom: 35px !important; 
            }
            .invoice-container {
                max-width: 100%;
                padding: 15px !important; 
                margin: 0 !important;
                overflow: visible !important;
                background-color: #fff !important; 
            }
            .print-only { display: block !important; } 
            .screen-only-decoration { display: none !important; } 
            .no-print { display: none !important; }
            * { box-shadow: none !important; color-adjust: exact !important; }
            .logo img { max-height: 50px !important; } 
            thead { display: table-header-group !important; } 
            tbody tr, .invoice-summary, .invoice-note { page-break-inside: avoid !important; }
            .print-footer { 
                display: block !important;
                border: none !important; 
            }
            body.use-hf-azul #print-header-azul,
            body.use-hf-azul #print-footer-azul {
                display: flex !important; 
            }
            body:not(.use-hf-azul) #print-header-azul,
            body:not(.use-hf-azul) #print-footer-azul {
                display: none !important;
            }
        }

        /* --- Reglas @page --- */
        @page {
             padding: 0.8cm 1cm 1cm 1cm;
             margin: 0cm 0cm 0cm 0cm;
        }

    </style>
</head>
<body class="bg-gray-100"> <!-- Clase base, sobrescrita por JS -->

    <!-- Encabezado/Pie Fijo para Impresión (Tema Azul) -->
    <div id="print-header-azul" class="print-only">
        <div class="deco-circle"></div>
    </div>
    <div id="print-footer-azul" class="print-only">
        <div class="deco-skew"></div>
    </div>

    <!-- Wrapper para padding general en pantalla -->
    <div class="invoice-wrapper">
        <!-- CONTENEDOR PRINCIPAL -->
        <div class="invoice-container">

            <!-- Decoración SUPERIOR para PANTALLA (Tema Azul) -->
            <div id="screen-header-azul" class="screen-only-decoration">
                <div class="deco-circle"></div>
            </div>

            <!-- Encabezado -->
            <div class="invoice-header">
                <div class="header-left">
                    <div class="logo" id="logo1"></div>
                    <div class="logo" id="logo2"></div>
                </div>
                <div class="header-right">
                     <div id="factura-line" class="detail-line hidden"><strong>Factura #:</strong> <span id="factura"></span></div>
                     <div id="fecha-line" class="detail-line hidden"><strong>Fecha:</strong> <span id="fecha"></span></div>
                     <div id="hora-line" class="detail-line hidden"><strong>Hora:</strong> <span id="hora"></span></div>
                     <div id="forma-pago-line" class="detail-line hidden"><strong>Forma de Pago:</strong> <span id="forma-pago"></span></div>
                </div>
            </div>

            <!-- Detalles De/Para -->
            <div class="sender-receiver-details">
                <div id="de-section" class="info-section hidden">
                    <!-- La etiqueta "De:" se eliminará de aquí y se generará dinámicamente si es necesario por JS -->
                    <span id="de"></span>
                </div>
                <div id="para-section" class="info-section hidden">
                    <!-- La etiqueta "Para:" se eliminará de aquí y se generará dinámicamente si es necesario por JS -->
                    <span id="para"></span>
                </div>
            </div>

            <!-- Tabla de Items -->
            <table class="invoice-table">
                <thead id="tabla-head"></thead>
                <tbody id="tabla-body"></tbody>
            </table>

            <!-- Resumen y Totales -->
            <div class="invoice-summary">
                 <div id="subtotal-line" class="summary-line hidden">
                    <span>Subtotal:</span>
                    <span id="subtotal"></span>
                </div>
                <!-- NUEVA LÍNEA PARA DESCUENTO -->
                <div id="descuento-line" class="summary-line hidden">
                    <span>Descuento:</span>
                    <span id="descuento"></span>
                </div>
                <!-- AJUSTE EN LA LÍNEA DE IVA -->
                 <div id="iva-label-line" class="summary-line hidden">
                     <span>IVA (<span id="iva-label-text"></span>):</span> <!-- Cambiado id de iva-label a iva-label-text -->
                     <span id="iva-label-value"></span> <!-- Este span ahora contendrá el valor del IVA (antes IVAMonto) -->
                 </div>
                 <!-- La línea de IVAMonto se puede eliminar o reutilizar si es necesario,
                      pero con el cambio anterior, 'iva-label-value' ya mostrará el monto.
                      Para simplificar, la comentaremos o eliminaremos del JS si no se usa.
                      Por ahora, la dejo comentada en el HTML por si se le da otro uso. -->
                 <!-- <div id="iva-monto-line" class="summary-line hidden">
                     <span>Monto IVA:</span>
                     <span id="iva-monto-value"></span>
                 </div> -->
                <div id="total-line" class="summary-line total-line hidden">
                    <span>Total:</span>
                    <span id="total"></span>
                </div>
            </div>

            <!-- Notas Adicionales -->
            <div id="nota-section" class="invoice-note hidden">
                 <strong>Nota:</strong>
                 <span id="nota"></span>
            </div>

            <!-- Decoración INFERIOR para PANTALLA (Tema Azul) -->
            <div id="screen-footer-azul" class="screen-only-decoration">
                <div class="deco-skew"></div>
            </div>

        </div> <!-- FIN .invoice-container -->
    </div> <!-- FIN .invoice-wrapper -->

    <!-- PIE DE PÁGINA GENÉRICO PARA IMPRESIÓN -->
     <!--
    <div class="print-footer print-only" id="print-footer">
        <p>Gracias por su preferencia.</p>
        -->
        <!-- Las siguientes líneas se comentarán en el JS para que no se rellenen -->
         <!--
        <p id="footer-company-info"></p>
        -->
        <!-- 
        <p>Fecha de impresión: <span id="print-date"></span></p>
        -->
        <!--
    </div>
    -->
    

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- Funciones Auxiliares ---
            function getUrlParams() {
                const params = {};
                const urlParams = new URLSearchParams(window.location.search);
                params.columna = urlParams.getAll('columna');
                const uniqueKeys = new Set(urlParams.keys());
                uniqueKeys.forEach(key => {
                    if (key !== 'columna') {
                        try {
                             params[key] = decodeURIComponent(urlParams.get(key));
                         } catch (e) {
                            console.error(`Error decodificando parámetro '${key}':`, e);
                            params[key] = urlParams.get(key); 
                        }
                    }
                });
                params.columna.forEach(colName => {
                    if (urlParams.has(colName)) {
                         try {
                             params[colName] = decodeURIComponent(urlParams.get(colName));
                         } catch (e) {
                             console.error(`Error decodificando datos de columna '${colName}':`, e);
                             params[colName] = urlParams.get(colName);
                         }
                    } else {
                        params[colName] = ''; 
                    }
                });
                return params;
            }

            function applyTheme(themeName) {
                const body = document.body;
                body.classList.remove('theme-purpura', 'theme-azul', 'bg-gray-100', 'use-hf-azul');
                try { 
                    document.getElementById('print-header-azul').style.display = 'none';
                    document.getElementById('print-footer-azul').style.display = 'none';
                } catch (e) { /* Ignorar */ }

                if (themeName === 'PurpuraGrad') {
                    body.classList.add('theme-purpura');
                } else if (themeName === 'AzulAbstractPro') {
                    body.classList.add('theme-azul');
                } else if (themeName === 'AzulAbstractProHF') {
                    body.classList.add('theme-azul', 'use-hf-azul');
                } else {
                     body.classList.add('bg-gray-100'); 
                }
            }

            function setElementTextAndVisibility(elementId, containerId, textContent, isHtml = false) {
                const element = document.getElementById(elementId);
                const container = document.getElementById(containerId);
                 if (!container) {
                    return; 
                 }
                 container.classList.add('hidden');
                 if (element && textContent && String(textContent).trim() !== '') {
                     if (isHtml) {
                         element.innerHTML = textContent;
                     } else {
                         element.textContent = textContent;
                     }
                     container.classList.remove('hidden'); 
                 } else if (!element && textContent && String(textContent).trim() !== '') {
                     if (isHtml) {
                        container.innerHTML = textContent;
                     } else {
                        container.textContent = textContent; 
                     }
                     container.classList.remove('hidden');
                 }
            }

            function setLogo(containerId, logoUrl, defaultUrl) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = ''; 
                const urlToUse = (logoUrl && String(logoUrl).trim() !== '') ? logoUrl : defaultUrl;
                if (urlToUse) {
                    const img = document.createElement('img');
                    img.src = urlToUse;
                    img.alt = "Logo";
                    img.onerror = () => {
                        console.warn(`No se pudo cargar el logo: ${urlToUse}`);
                        container.innerHTML = ''; 
                    };
                    container.appendChild(img);
                }
            }

            /**
             * CAMBIO: Función para aplicar estilo a las etiquetas De/Para dinámicamente.
             * Aplica <strong> a la parte del texto antes del primer ':' en cada línea.
             * @param {string} textContent - El texto original.
             * @param {string} defaultLabel - La etiqueta por defecto si no se encuentra ':' (ej. "De:", "Cliente:").
             * @returns {string} - El texto con formato HTML.
             */
            function styleSenderReceiverContent(textContent, defaultLabel) {
                if (!textContent || String(textContent).trim() === '') {
                    return ''; // No hay contenido, no mostrar nada.
                }

                const lines = String(textContent).split('\n');
                const processedLines = lines.map(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > -1) {
                        // Aplicar estilo hasta el ':' (incluido)
                        const labelPart = line.substring(0, colonIndex + 1);
                        const valuePart = line.substring(colonIndex + 1);
                        return `<strong class="dynamic-label">${labelPart}</strong>${valuePart}`;
                    } else {
                        // Si no hay ':', se podría o no añadir la etiqueta por defecto.
                        // Por ahora, si el usuario no pone ':', no forzamos la etiqueta.
                        // Si se quisiera forzar la etiqueta: return `<strong class="dynamic-label">${defaultLabel}</strong> ${line}`;
                        return line; // Devuelve la línea tal cual si no hay ':'
                    }
                });
                return processedLines.join('<br>');
            }


            // --- Lógica Principal ---
            function populateInvoice() {
                const params = getUrlParams();
                // console.log("Parámetros procesados:", params);

                const defaultLogo1Url = 'https://cdn.discordapp.com/attachments/925921694332375073/1358565361456513034/Sin_titulo-2_svg_formato.svg?ex=68207857&is=681f26d7&hm=efa22e96ea5401e72b34ea9e37c898865d23b6156b55692c7b853f2ac016a23d&';
                const defaultLogo2Url = 'https://cdn.discordapp.com/attachments/925921694332375073/1358565361779343500/Sin_titulo-3.svg?ex=68207857&is=681f26d7&hm=88bbd5e013af44c72cee26fbacc231dfe126d658bfc9529a9a61b73ad47895a6&';

                applyTheme(params.tema);
                setLogo('logo1', params.Logo1, defaultLogo1Url);
                setLogo('logo2', params.Logo2, defaultLogo2Url);

                setElementTextAndVisibility('factura', 'factura-line', params.Factura);
                setElementTextAndVisibility('fecha', 'fecha-line', params.Fecha);
                setElementTextAndVisibility('hora', 'hora-line', params.Hora);
                setElementTextAndVisibility('forma-pago', 'forma-pago-line', params.FormaPago);

                const styledDeContent = styleSenderReceiverContent(params.De, 'De:'); 
                setElementTextAndVisibility('de', 'de-section', styledDeContent, true); 

                const styledClienteContent = styleSenderReceiverContent(params.Cliente, 'Cliente:');
                setElementTextAndVisibility('para', 'para-section', styledClienteContent, true); 
                                
                const tableHead = document.getElementById('tabla-head');
                const tableBody = document.getElementById('tabla-body');
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                let calculatedTotal = 0;
                let amountColumnIndex = -1;
                const columnNames = params.columna || [];

                if (columnNames.length > 0) {
                    const headerRow = document.createElement('tr');
                    columnNames.forEach((colName, index) => {
                        const th = document.createElement('th');
                        th.textContent = colName;
                        th.className = (index === 0) ? 'text-left' : 'text-right';
                        headerRow.appendChild(th);
                        if (typeof colName === 'string' && colName.toLowerCase() === 'monto') {
                           amountColumnIndex = index;
                        }
                    });
                    if (amountColumnIndex === -1 && columnNames.length > 0) { // Asegurarse que columnNames no está vacío
                       amountColumnIndex = columnNames.length - 1;
                    }
                    tableHead.appendChild(headerRow);

                    const firstColName = columnNames[0];
                    const firstColData = params[firstColName] ? String(params[firstColName]).split(',') : [];

                    if (firstColData.length > 0 && firstColData[0].trim() !== '') {
                        const numRows = firstColData.length;
                        const rowDataArrays = columnNames.map(colName =>
                            params[colName] ? String(params[colName]).split(',') : Array(numRows).fill('')
                        );
                        const consistentData = rowDataArrays.every(arr => arr.length === numRows);
                        if (!consistentData) {
                            console.warn("Advertencia: Las columnas no tienen el mismo número de elementos.");
                        }
                        for (let i = 0; i < numRows; i++) {
                            const bodyRow = document.createElement('tr');
                            let rowAmount = 0;
                            columnNames.forEach((colName, j) => {
                                const td = document.createElement('td');
                                const cellData = (rowDataArrays[j] && rowDataArrays[j][i] !== undefined)
                                                 ? String(rowDataArrays[j][i]).trim()
                                                 : '';
                                td.textContent = cellData;
                                td.className = (j === 0) ? 'text-left' : 'text-right';
                                bodyRow.appendChild(td);
                                if (j === amountColumnIndex) {
                                    const cleanedData = cellData.replace(/[^\d.,-]/g, '').replace(',', '.');
                                    const parsedAmount = parseFloat(cleanedData);
                                    if (!isNaN(parsedAmount)) {
                                        rowAmount = parsedAmount;
                                    }
                                }
                            });
                            tableBody.appendChild(bodyRow);
                            calculatedTotal += rowAmount;
                        }
                    } else {
                         const emptyRow = tableBody.insertRow();
                         const emptyCell = emptyRow.insertCell();
                         emptyCell.colSpan = columnNames.length || 1; // Evitar colspan 0
                         emptyCell.textContent = "No hay elementos para mostrar.";
                         emptyCell.style.textAlign = "center";
                         emptyCell.style.padding = "20px";
                    }
                } else {
                     const emptyRow = tableBody.insertRow();
                     const emptyCell = emptyRow.insertCell();
                     emptyCell.colSpan = 1; 
                     emptyCell.textContent = "No se ha definido la estructura de la tabla.";
                     emptyCell.style.textAlign = "center";
                     emptyCell.style.padding = "20px";
                }

                // --- Rellenar Resumen ---
                const locale = 'es-ES'; 
                const currencyOptions = { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }; 

                setElementTextAndVisibility('subtotal', 'subtotal-line', params.Subtotal);
                
                // NUEVO: Procesar y mostrar Descuento
                setElementTextAndVisibility('descuento', 'descuento-line', params.Descuento);

                // AJUSTE: Procesar IVA
                // El texto de la etiqueta IVA (ej. "18%") va a 'iva-label-text'
                setElementTextAndVisibility('iva-label-text', 'iva-label-line', params.IVALine);
                // El monto del IVA (antes en params.IVAMonto) va a 'iva-label-value'
                setElementTextAndVisibility('iva-label-value', 'iva-label-line', params.IVAMonto);

                // La línea original de 'iva-monto-line' ya no es necesaria si se combinó.
                // Si 'iva-monto-line' fue eliminada del HTML, esta llamada no hará nada o puedes eliminarla.
                // document.getElementById('iva-monto-line')?.classList.add('hidden');


                const formattedCalculatedTotal = calculatedTotal.toLocaleString(locale, currencyOptions); 
                let totalValueToShow = formattedCalculatedTotal; 
                 if (params.Total && String(params.Total).trim() !== '') {
                    totalValueToShow = params.Total; 
                }
                 // Mostrar línea Total si hay algún valor en el resumen o si se calculó algo
                 // MODIFICADO: Añadir Descuento a la condición
                 const shouldShowTotal = (params.Subtotal || params.Descuento || params.IVALine || params.IVAMonto || params.Total || calculatedTotal !== 0);
                 if (shouldShowTotal) {
                     setElementTextAndVisibility('total', 'total-line', totalValueToShow);
                 } else {
                      const totalContainer = document.getElementById('total-line');
                      if (totalContainer) totalContainer.classList.add('hidden');
                 }


                setElementTextAndVisibility('nota', 'nota-section', params.Nota);

                // --- COMENTAR PIE DE PÁGINA DINÁMICO ---
                // Ya no se rellenará la información de la empresa ni la fecha de impresión aquí.
                /*
                const printFooterInfo = document.getElementById('footer-company-info');
                const printDate = document.getElementById('print-date');
                if (printFooterInfo) {
                     // Se usaba params.De para esto, pero ahora el contenido de 'De' es más flexible.
                     // Podrías necesitar un nuevo parámetro si quieres esta info específica.
                     // Por ahora, se comenta.
                     // const deContent = params.De || ''; 
                     // const deLines = deContent.split('\n');
                     // printFooterInfo.textContent = (deLines.length > 1 ? deLines[1].trim() : deLines[0].trim()) || '';
                }
                 if(printDate) {
                     const now = new Date();
                     const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
                     const timeOptions = { hour: '2-digit', minute: '2-digit' };
                     printDate.textContent = now.toLocaleDateString(locale, dateOptions) + ' ' + now.toLocaleTimeString(locale, timeOptions);
                 }
                 */
            }

            populateInvoice();
        });
    </script>
</body>
</html>
